
# Human-Vehicle Mutual Exclusion System  
# 人车互斥实时监测与告警系统

基于 **YOLOv8** 的人车互斥实时监测系统，用于检测人员与车辆在同一画面中的危险接近行为，并在达到风险阈值时触发 **邮件告警** 与 **本地日志记录**。

---

## 功能特点

- 实时检测摄像头中的人员和车辆
- 根据像素距离和透视权重计算安全距离
- 风险等级分为 SAFE / WARNING / DANGER
- 危险状态自动触发：
  - 邮件告警
  - 本地日志记录
- 冷却时间机制避免重复告警
- OpenCV 实时可视化显示
- 叉车运动状态检测：通过帧差法+高斯模糊分析叉车区域像素变化，精准判断运动/静止状态
- 运动叉车标记：检测到运动的叉车，边框下方标注运动状态，且运动状态持续显示5秒（可配置）
- 运动检测参数可视化：画面左上角实时显示运动延迟配置参数，直观查看当前设置

---

## 环境要求

- Python 3.11+
- 依赖库：
  - `opencv-python`
  - `ultralytics`
  - `yagmail`

安装依赖命令：

```bash
pip install opencv-python ultralytics yagmail
````
---

## 项目文件结构

```text
├── final.py                     # 主程序
├── README.md                    # 项目说明文档
├── .gitignore                   # Git 忽略规则
├── yolov8n.pt                   # YOLOv8 模型文件（不提交）
└── vehicle_person_alarm.log     # 告警日志文件（运行生成）
```

### 文件说明表

| 文件名                        | 说明                   |
| -------------------------- | -------------------- |
| `final.py`                 | 系统主程序，负责检测、判断、告警与可视化 |
| `.gitignore`               | 忽略模型文件、日志文件及缓存       |
| `yolov8n.pt`               | YOLOv8 预训练模型（需自行下载）  |
| `vehicle_person_alarm.log` | 告警日志文件，JSON 行格式      |

---

## 使用方法

### 1. 邮箱告警配置（必须）

#### Windows

```bash
setx ALARM_EMAIL_SENDER "发送告警的邮箱"
setx ALARM_EMAIL_AUTH "邮箱SMTP授权码"
setx ALARM_EMAIL_RECEIVERS "接收邮箱1,接收邮箱2"
```

#### Linux / macOS

```bash
export ALARM_EMAIL_SENDER="发送告警的邮箱"
export ALARM_EMAIL_AUTH="邮箱SMTP授权码"
export ALARM_EMAIL_RECEIVERS="接收邮箱1,接收邮箱2"
```

> ⚠️ QQ 邮箱需开启 SMTP 并使用授权码，而非登录密码。

### 2. 启动程序

```bash
python final.py
```

* 默认使用本地摄像头（`VideoCapture(0)`）
* 程序启动后弹出实时检测窗口
* 按 `ctrl+c` 键退出程序

---

## 报警逻辑

1. 读取摄像头视频流
2. 使用 YOLOv8 检测目标
3. 分类提取人员与车辆
4. 计算 bbox 中心点距离
5. 根据 y 轴透视权重调整距离
6. 计算安全半径并判断风险等级
7. 若为 DANGER：

   * 发送邮件告警
   * 写入日志
8. 已触发告警的摄像头进入冷却时间，避免重复报警

---

## 人车互斥判定模型

* 使用 bbox 中心点作为目标位置
* 计算像素欧氏距离
* 使用 y 轴比例作为透视加权：

```text
d_real = d_pixel × perspective_weight(y)
```

* 安全半径 = 基础半径 + 速度因子
* 风险等级：

  * SAFE：安全
  * WARNING：预警
  * DANGER：危险，触发告警

---

## 叉车运动检测算法

* 帧预处理：将实时帧灰度化 → 高斯模糊（21x21 核），消除环境噪点
* 帧差计算：计算当前帧与前一帧的绝对差值，捕捉画面像素变化
* 二值化处理：设置阈值 25，超过阈值的像素判定为变化像素，生成二值化图像
* 膨胀处理：对二值化图像进行膨胀操作，进一步消除噪点，提升检测稳定性
* 叉车区域分析：统计每个叉车 bbox 内的变化像素数，超过 motion_threshold 阈值则判定为运动
* 运动状态延迟：叉车停止运动后，运动状态标记仍持续显示 5 秒，避免瞬时静止导致的误判


## 运动状态判定逻辑

* 运动中：叉车 bbox 内变化像素数达标，标注 “运动中（延迟中）”，颜色为蓝色
* 静止：叉车 bbox 内变化像素数不达标，标注 “静止”，颜色为灰色
* 延迟过渡：叉车停止运动后，标注 “运动中（剩余 X 秒）”，持续 5 秒后转为静止标记


---

## 可视化说明

| 状态      | 显示效果           |
| -------   | -------------- |
| SAFE      | 绿色边框           |
| WARNING   | 黄色边框           |
| DANGER    | 红色边框           |
| 文本      | 显示在车辆边框上方，实时更新 |
| 文本      | 显示在车辆边框上方，实时更新 |
|叉车运动中  | 叉车边框下方标注 “运动中”，蓝色文本|
|叉车静止	  | 叉车边框下方标注 “静止”，灰色文本|
|运动参数	  | 画面左上角显示 “运动延迟：5 秒”，蓝色文本|

---

## 日志说明

* 日志格式：JSON（每行一条）
* 字段说明：

  * `camera_id`：摄像头编号
  * `alarm_type`：告警类型
  * `alarm_time`：告警时间
  * `detail`：告警详情
  * `email_send_success`：邮件发送是否成功


示例：

```json
{
  "camera_id": "CAM_01",
  "alarm_type": "人车互斥",
  "alarm_time": "2026-02-07 15:45:12",
  "detail": "人员0 与车辆1 距离 52.3，低于安全阈值 80.0",
  "email_send_success": true
}
```

